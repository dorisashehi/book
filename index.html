<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <title>Books</title>

    <link rel="stylesheet" href="./assets/style/main.css">

    <script>

        const myLibrary = []; //array to save books added

        function Book(title, author, pages, description, read = false){
            this.title = title
            this.author = author
            this.pages = pages
            this.description = description
            this.read = read
        }

        Book.prototype.setStatus = function (read) { //function to change status
            this.read = (read) ? true : false
        }

        Book.prototype.getStatus = function(){ //function to get status
            return this.read
        }

        function seedBooks(){ //function test to add some fake books
            var book1 = new Book("Hobbit", "J.R.R. Tolkien", 29, "Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. ");
            var book2 = new Book("New Storem", "Cicero", 295, "There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don't look even slightly believable.")
            var book3 = new Book("Lorem Ipsum ", "Richard", 500, "Lorem Ipsum comes from sections 1.10.32 and 1.10.33 of de Finibus Bonorum et Malorum (The Extremes of Good and Evil) by Cicero, written in 45 BC.")

            myLibrary.push(book1, book2, book3)
        }

        function loadBooks(){ //function to loaf books
            const row = document.querySelector(".line");
            var content = ""

            if(myLibrary.length > 0)
            {
                content = myLibrary.map((book, index) => getColumns(book, index)).join('')
            }
            else{
                const emptyContent = document.createElement("div")
                emptyContent.classList.add("error")
                emptyContent.textContent = "No books available! Add a new one."
                content = emptyContent.innerHTML
            }
            row.innerHTML = content
            getRemoveCard() //add listeners for remove button
            changeStatus()
        }

        function getColumns(book, index){ //function to get books in columns

            return(
                `
                    <div class="col-lg-4 h-320">

                        <div class="card mb-3" style="max-width: 540px; height: 100%;">
                            <div class="row g-0 h-100">
                                <div class="col-md-4 pl-0">
                                    <img src="./assets/images/book.jpg" alt="Trendy Pants and Shoes" class="img-fluid rounded-start">
                                </div>
                                <div class="col-md-8 p-0">
                                    <div class="remove-icon" data-getid="${index}">
                                        <i class="fas fa-remove" alt="Remove Book"></i>
                                    </div>
                                    <div class="card-body pl-0 pr-5">
                                        <h5 class="card-title">${book.title}</h5>
                                        <p class="card-text">
                                            <b>By:</b> ${book.author}
                                        </p>
                                        <p class="card-text">
                                            <span>${book.description}</span>
                                        </p>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="status" ${(book.read)? "checked" : ""} name="status" data-id="${index}">
                                            <label class="form-check-label" for="status">Mark as read</label>
                                        </div>
                                        <p class="card-text">
                                            <small class="text-muted">${book.pages} pages</small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            )

        }

        function getRemoveCard(){ //function to remove a book
            const removeBtn = document.querySelectorAll(".remove-icon");

            Array.from(removeBtn).map((btn) => {
                btn.addEventListener("click", () => {
                    const id = btn.getAttribute('data-getid')
                    myLibrary.splice(id, 1);
                    loadBooks()
                })
            })

        }

        let errors = [];
        function addNewBook(){ //function to add a book
            const dialog = document.getElementById("dialog");
            const closeDialog = dialog.querySelector("#js-close");
            const openDialog = document.getElementById("open-dialog");
            const submitBtn = document.getElementById("submit");
            const inputs = dialog.querySelectorAll("input");
            const form = dialog.querySelector("form")

            const textRegExp =  /^[a-zA-Z]/;


            ["title", "author", "description", "pages"].map((item) => { //on value change

                form.elements[item].addEventListener("input", () => {

                    let element = form.elements[item]
                    let elementError = form.elements[item].nextElementSibling;
                    let error = true;

                    if (item == "pages" &&  element.value > 0) error = false;
                    if(element.value.length > 0 && textRegExp.test(element.value)) error = false;
                    if(error) {elementError.classList.add("error"); errors.push(item)}
                    else  elementError.classList.remove("error")

                })
            })



            submitBtn.addEventListener("click", (e) => { //on button click


                if( form.elements["title"].value !== '' &&
                    form.elements["author"].value !== '' &&
                    form.elements["pages"].value !== '' &&
                    form.elements["description"].value !== '' &&
                    form.elements["status"].value !== '' &&
                    errors.length == 0
                ){
                    myLibrary.push(new Book(form.elements["title"].value, form.elements["author"].value, form.elements["pages"].value, form.elements["description"].value, form.elements["status"].value))
                    loadBooks() //refresh withouts loading
                    removeErrors(form);
                }
                else{
                    e.preventDefault();
                    showErrors(form)
                }
            });

            openDialog.addEventListener("click", () => {
                dialog.showModal()
                removeErrors(form); //remove errors
            })

            closeDialog.addEventListener("click", (e) => {
                e.preventDefault();
                dialog.close();
            });

        }

        function showErrors(form){ //function to show errors
            ["title", "author", "description", "pages"].map((item) => {
                if(form.elements[item].value === '') form.elements[item].nextElementSibling.classList.add("error")
            })
        }

        function removeErrors(form){ //function to remove errors
            errors = [];
            ["title", "author", "description", "pages"].map((item) => {
                if(form.elements[item].value === '') form.elements[item].nextElementSibling.classList.remove("error");
                form.elements[item].value = ''
            })
        }


        function changeStatus(){ //function to change the ctatus of the book
            const statusCheck = document.querySelectorAll('.card-body #status')

            Array.from(statusCheck).map((checkbox) => {
                checkbox.addEventListener('click', () => {

                    let bookID = checkbox.getAttribute('data-id')
                    if(!myLibrary[bookID].getStatus()) {
                        myLibrary[bookID].setStatus(true)
                    }else{
                        myLibrary[bookID].setStatus(false)
                    }
                    loadBooks() //refresh
                })
            })

        }
        document.addEventListener("DOMContentLoaded", () => { //main function
            seedBooks()  //defaut values
            loadBooks()  //load all books
            addNewBook() //add new book
        });



    </script>
</head>
<body>
    <div class="container mb-5">
        <div class="row col-12 mb-5">
            <h1></h1>
            <div class="row col-12">
                <!-- Button trigger modal -->
                <button type="button" class="btn btn-primary" id="open-dialog">
                    Add New
                </button>
            </div>
        </div>
        <div class="row col-12 g-3 line"></div>
        <!-- Modal -->
        <dialog id="dialog">
            <form method="dialog">
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" class="form-control" id="title" name="title" placeholder="Enter title" required>
                    <em class="title-error">Put a valid name (text only)</em>
                </div>
                <div class="form-group">
                    <label for="author">Author</label>
                    <input type="text" class="form-control" id="author" name="author" placeholder="Enter author" required>
                    <em class="author-error">Put a valid author (text only)</em>
                </div>
                <div class="form-group">
                    <label for="pages">Pages</label>
                    <input type="number" class="form-control" id="pages" name="pages" placeholder="Enter Pages" required>
                    <em class="pages-error">Put a valid number of pages</em>
                </div>
                <div class="form-group">
                    <label for="title">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="5" maxlength="30" required></textarea>
                    <em class="description-error">Put a valid description (text only)</em>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="status" name="status" required>
                    <label class="form-check-label" for="status">Mark as read</label>
                    <!-- <span class="help-block">Something may have gone wrong</span> -->
                </div>
                <div class="mt-4">
                    <input type="submit" id="submit" value="Submit" class="btn btn-primary" formnovalidate />
                    <input type="submit" class="btn btn-primary" id="js-close" value="Close" />
                </div>
            </form>
        </dialog>
    </div>
</body>
</html>